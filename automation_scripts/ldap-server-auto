
#!/bin/bash

echo "installing git"
yum -y install git
echo "clonig git"
echo "cloning fjemal's NTI-310 GitHub..."
git clone https://github.com/fjemal/NTI-310.git /tmp/NTI-310
git config --global user.name "fjemal"
git config --global user.email "fjemal01@seattlecentral.edu"
ehco "copying config files"
cp /tmp/NTI-310/config_scripts/ldap.conf /etc/ldap.conf
#Installing ldap server
#https://www.server-world.info/en/note?os=CentOS_7&p=openldap

#This is a basis for students to create a fully functioning build, compile, and deploy script.
echo "intalling servers and clients packages"
yum -y update
yum -y install openldap compat-openldap openldap-clients openldap-servers openldap-servers-sql openldap-devel

echo "copying config files"
cp /usr/share/openldap-servers/DB_CONFIG.example /var/lib/ldap/DB_CONFIG 
chown ldap. /var/lib/ldap/DB_CONFIG

# some source editing
# Tell SE linux what's going on, so that it doesn't freek

echo "installing and enabling apache server"
yum -y install httpd
systemctl enable httpd
systemctl start httpd
echo "allowing ldap to httpd"
setsebool -P httpd_can_connect_ldap on


# decent config guide: http://www.itzgeek.com/how-tos/linux/centos-how-tos/install-configure-phpldapadmin-centos-7-ubuntu-16-04.html
#Note: LDAP comes up completely insecure, with Anonymous login enabled by default... this is not a good and happy thing, so fix 
#it in the config file
#(prompt for user input), the following is currently a manual config, but could be automated fairly easily
 
echo "start slapd service" 
systemctl start slapd.service 
systemctl enable slapd.service 

echo "generating ldap passowrd"
newsecret=$(slappasswd -g)
newhash=$(slappassed -s "$newsecret")
echo -n "$newsecret" > /root/ldap_admin_pass

chmod 600 /root/ldap_admin_pass
cp /tmp/NTI-310/config_scripts/db.ldif /etc/openldap/slapd.d/db.ldif
echo "add db.ldif to ldap configuration"

 dn: olcDatabase={2}hdb,cn=config
changetype: modify
replace: olcSuffix
olcSuffix: dc=ldap,dc=local

dn: olcDatabase={2}hdb,cn=config
changetype: modify
replace: olcRootDN
olcRootDN: cn=ldapadm,dc=ldap,dc=local

dn: olcDatabase={2}hdb,cn=config
changetype: modify
replace: olcRootPW
olcRootPW: $newhash >> /etc/openldap/slapd.d/db.ldif
ldapmodify -Y EXTERNAL  -H ldapi:/// -f /etc/openldap/slapd.d/db.ldif

systemctl start slapd.service
systemctl enable slapd.service

#Once you are done with the ldif file, send the configuration to the LDAP server.

# ldapmodify -Y EXTERNAL  -H ldapi:/// -f db.ldif
echo "copying monitor.ldif to ldap server"
cp /tmp/NTI-310/config_scripts/monitor.ldif /etc/openldap/slapd.d/monitor.ldif
chown ldap. /etc/openldap/slapd.d/monitor.ldif
ldapmodify -Y EXTERNAL  -H ldapi:/// -f /etc/openldap/slapd.d/monitor.ldif



#Create LDAP certificate:
echo "Copying cert.ldif"
cp /tmp/NTI-310/config_scripts/certs.ldif /etc/openldap/slapd.d/certs.ldif
ldapmodify -Y EXTERNAL  -H ldapi:/// -f /etc/openldap/slapd.d/certs.ldif

echo "Adding schemas"
ldapadd -Y EXTERNAL -H ldapi:/// -f /etc/openldap/schema/cosine.ldif
ldapadd -Y EXTERNAL -H ldapi:/// -f /etc/openldap/schema/nis.ldif
ldapadd -Y EXTERNAL -H ldapi:/// -f /etc/openldap/schema/inetorgperson.ldif


#Set up LDAP database:
# cp /usr/share/openldap-servers/DB_CONFIG.example /var/lib/ldap/DB_CONFIG
# chown ldap:ldap /var/lib/ldap/*

echo "adding new entry cn=inetorgperson,cn=schema,cn=config"
echo"Generating base.ldif file for your domain"
cp /tmp/NTI-310/config_scripts/base.ldif /etc/openldap/slapd.d/base.ldif
ldapadd -x -D "cn=ldapadm,dc=ldap,dc=local" -f /etc/openldap/slapd.d/base.ldif -y /root/ldap_admin_pass

dn: dc=ldap,dc=local
dc: ldap
objectClass: top
objectClass: domain

dn: cn=ldapadm ,dc=ldap,dc=local
objectClass: organizationalRole
cn: ldapadm
description: LDAP Manager

dn: ou=People,dc=ldap,dc=local
objectClass: organizationalUnit
ou: People

dn: ou=Group,dc=ldap,dc=local
objectClass: organizationalUnit
ou: Group
#Build the directory structure.
ldapadd -x -W -D "cn=ldapadm,dc=ldap,dc=local" -f base.ldif

echo "installing phpldadadmin"
yum -y install epel-release
yum install -y phpldapadmin
cp /tmp/NTI-310/config_scripts/config.php /etc/phpldapadmin/config.php
sed -i 's,Require local,#Require local\n    Require all granted,g' /etc/httpd/conf.d/phpldapadmin.conf
cp /tmp/NTI-310/config_scripts/phpldapadmin.conf /etc/httpd/conf.d/phpldapadmin.conf
#restart httpd and slapd
systemctl restart httpd
systemctl restart slapd
#allow firewall
firewall-cmd --permanent --zone=public --add-service=http
firewall-cmd --reload


#  Web-based tool for managing LDAP servers
#


